<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Karolina Comments</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        h1 { font-size: 20px; color: #333; margin: 0 0 20px 0; }
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.waiting { background: #fff3cd; color: #856404; }
        .pending-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn:disabled { background: #ccc; }
        #log { margin-top: 15px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Karolina Comments</h1>
        <div id="status" class="status waiting">Connecting...</div>
        <div id="pendingList"></div>
        <button class="btn" onclick="processComments()" id="processBtn" disabled>
            Insert All Comments
        </button>
        <div id="log"></div>
    </div>

    <script>
        const GIST_RAW = 'https://gist.githubusercontent.com/taxesfortacos/141fe561464485dce58ad05f8c9b180c/raw/comments.json';
        let pendingComments = [];
        
        function log(msg) {
            document.getElementById('log').innerHTML = msg + '<br>' + document.getElementById('log').innerHTML;
        }
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '‚úÖ Connected - Polling for comments...';
                pollForComments();
                setInterval(pollForComments, 5000);
            }
        });
        
        async function pollForComments() {
            try {
                const response = await fetch(GIST_RAW + '?t=' + Date.now());
                const data = await response.json();
                pendingComments = (data.comments || []).filter(c => c.status === 'pending');
                
                if (pendingComments.length > 0) {
                    document.getElementById('pendingList').innerHTML = pendingComments.map(c => 
                        `<div class="pending-item"><b>"${c.searchText}"</b><br>${c.comment}</div>`
                    ).join('');
                    document.getElementById('processBtn').disabled = false;
                    log(`Found ${pendingComments.length} comment(s)`);
                }
            } catch (err) {
                log('Poll: ' + err.message);
            }
        }
        
        async function processComments() {
            document.getElementById('processBtn').disabled = true;
            
            for (const c of pendingComments) {
                try {
                    await Word.run(async (context) => {
                        const results = context.document.body.search(c.searchText, { matchCase: false });
                        results.load('items');
                        await context.sync();
                        if (results.items.length > 0) {
                            results.items[0].insertComment(c.comment);
                            await context.sync();
                            log('‚úÖ Added: ' + c.searchText);
                        } else {
                            log('‚ùå Not found: ' + c.searchText);
                        }
                    });
                } catch (err) {
                    log('Error: ' + err.message);
                }
            }
            pendingComments = [];
            document.getElementById('pendingList').innerHTML = '<p>All comments processed!</p>';
        }
    </script>
</body>
</html>
