<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Karolina Comments</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        h1 { font-size: 18px; color: #333; margin: 0 0 15px 0; }
        .status { padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
        .status.connected { background: #d4edda; color: #155724; }
        .pending-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea; font-size: 13px; }
        .pending-item .type { font-size: 11px; color: #667eea; font-weight: 600; margin-bottom: 4px; }
        .btn { background: #667eea; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 8px; font-size: 14px; }
        .btn:disabled { background: #ccc; }
        .btn.secondary { background: #28a745; }
        #log { margin-top: 12px; font-size: 10px; color: #666; max-height: 80px; overflow-y: auto; background: #f9f9f9; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Karolina</h1>
        <div id="status" class="status">Connecting...</div>
        <div id="pendingList"></div>
        <button class="btn" onclick="processAll()" id="processBtn" disabled>Apply All Suggestions</button>
        <div id="log"></div>
    </div>
    <script>
        const GIST_URL = 'https://gist.githubusercontent.com/taxesfortacos/141fe561464485dce58ad05f8c9b180c/raw/comments.json';
        let pendingItems = [];
        
        function log(msg) { 
            const l = document.getElementById('log');
            l.innerHTML = new Date().toLocaleTimeString() + ': ' + msg + '<br>' + l.innerHTML; 
        }
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '‚úÖ Connected - Listening for suggestions...';
                pollForItems();
                setInterval(pollForItems, 5000);
            }
        });
        
        async function pollForItems() {
            try {
                const response = await fetch(GIST_URL + '?t=' + Date.now());
                const data = await response.json();
                pendingItems = (data.comments || []).filter(c => c.status === 'pending');
                
                if (pendingItems.length > 0) {
                    document.getElementById('pendingList').innerHTML = pendingItems.map(c => {
                        const isSuggestion = c.type === 'suggestion' || c.newText;
                        return '<div class="pending-item">' +
                            '<div class="type">' + (isSuggestion ? '‚úèÔ∏è SUGGESTION' : 'üí¨ COMMENT') + '</div>' +
                            '<b>"' + c.searchText + '"</b>' +
                            (c.newText ? '<br>‚Üí "' + c.newText + '"' : '') +
                            (c.comment ? '<br><i>' + c.comment + '</i>' : '') +
                            '</div>';
                    }).join('');
                    document.getElementById('processBtn').disabled = false;
                } else {
                    document.getElementById('pendingList').innerHTML = '<p style="color:#888;font-size:13px">No pending suggestions. Tell Karolina what to change!</p>';
                    document.getElementById('processBtn').disabled = true;
                }
            } catch (err) {
                log('Poll error: ' + err.message);
            }
        }
        
        async function processAll() {
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = 'Applying...';
            
            await Word.run(async (context) => {
                // Enable Track Changes so edits show as suggestions
                context.document.changeTrackingMode = Word.ChangeTrackingMode.trackAll;
                
                for (const item of pendingItems) {
                    try {
                        const results = context.document.body.search(item.searchText, { matchCase: false });
                        results.load('items');
                        await context.sync();
                        
                        if (results.items.length > 0) {
                            const range = results.items[0];
                            
                            if (item.newText !== undefined) {
                                // This is a suggestion - replace text (will show as tracked change)
                                range.insertText(item.newText, Word.InsertLocation.replace);
                                log('‚úèÔ∏è Suggested: "' + item.searchText + '" ‚Üí "' + item.newText + '"');
                            } else if (item.comment) {
                                // This is a comment
                                range.insertComment(item.comment);
                                log('üí¨ Comment added for: ' + item.searchText);
                            }
                            await context.sync();
                        } else {
                            log('‚ùå Not found: ' + item.searchText);
                        }
                    } catch (err) {
                        log('Error: ' + err.message);
                    }
                }
            });
            
            document.getElementById('pendingList').innerHTML = '<p style="color:green">‚úÖ All suggestions applied!</p>';
            document.getElementById('processBtn').textContent = 'Apply All Suggestions';
            pendingItems = [];
        }
    </script>
</body>
</html>
