<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Karolina</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        h1 { font-size: 18px; margin: 0 0 15px 0; }
        .status { padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; background: #d4edda; color: #155724; }
        .pending-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea; font-size: 12px; }
        .btn { background: #667eea; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 8px; }
        .btn:disabled { background: #ccc; }
        #log { margin-top: 12px; font-size: 10px; color: #666; max-height: 80px; overflow-y: auto; background: #f9f9f9; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Karolina</h1>
        <div id="status" class="status">Connecting...</div>
        <div id="pendingList"></div>
        <button class="btn" onclick="processAll()" id="processBtn" disabled>Apply All</button>
        <div id="log"></div>
    </div>
    <script>
        // Use GitHub API instead of raw (no caching)
        const GIST_API = 'https://api.github.com/gists/141fe561464485dce58ad05f8c9b180c';
        let pendingItems = [];
        
        function log(msg) { 
            document.getElementById('log').innerHTML = msg + '<br>' + document.getElementById('log').innerHTML; 
        }
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                document.getElementById('status').textContent = '‚úÖ Connected - Polling...';
                pollForItems();
                setInterval(pollForItems, 5000);
            }
        });
        
        async function pollForItems() {
            try {
                const response = await fetch(GIST_API, {
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });
                const gist = await response.json();
                const content = gist.files['comments.json'].content;
                const data = JSON.parse(content);
                pendingItems = (data.comments || []).filter(c => c.status === 'pending');
                
                document.getElementById('status').textContent = '‚úÖ Connected - ' + pendingItems.length + ' pending';
                
                if (pendingItems.length > 0) {
                    document.getElementById('pendingList').innerHTML = pendingItems.map(c => 
                        '<div class="pending-item"><b>"' + c.searchText + '"</b><br>üí¨ ' + (c.comment || c.newText) + '</div>'
                    ).join('');
                    document.getElementById('processBtn').disabled = false;
                } else {
                    document.getElementById('pendingList').innerHTML = '<p style="color:#888">No pending items</p>';
                    document.getElementById('processBtn').disabled = true;
                }
            } catch (err) {
                log('Error: ' + err.message);
            }
        }
        
        async function processAll() {
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = 'Applying...';
            
            await Word.run(async (context) => {
                context.document.changeTrackingMode = Word.ChangeTrackingMode.trackAll;
                
                for (const item of pendingItems) {
                    try {
                        const results = context.document.body.search(item.searchText, { matchCase: false });
                        results.load('items');
                        await context.sync();
                        
                        if (results.items.length > 0) {
                            if (item.newText !== undefined) {
                                results.items[0].insertText(item.newText, Word.InsertLocation.replace);
                            } else if (item.comment) {
                                results.items[0].insertComment(item.comment);
                            }
                            await context.sync();
                            log('‚úÖ ' + item.searchText);
                        } else {
                            log('‚ùå Not found: ' + item.searchText);
                        }
                    } catch (err) {
                        log('Error: ' + err.message);
                    }
                }
            });
            
            document.getElementById('pendingList').innerHTML = '<p style="color:green">‚úÖ Done! Tell Karolina "applied"</p>';
            document.getElementById('processBtn').textContent = 'Apply All';
            pendingItems = [];
        }
    </script>
</body>
</html>
