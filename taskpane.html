<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Karolina</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        h1 { font-size: 16px; margin: 0 0 10px 0; }
        .status { padding: 6px 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; background: #d4edda; color: #155724; }
        .item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea; font-size: 11px; }
        .item.applied { border-left-color: #28a745; opacity: 0.6; }
        .item.failed { border-left-color: #dc3545; }
        .item.heading { border-left-color: #ff9800; background: #fff8e1; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-text { font-weight: 600; }
        .item-comment { color: #666; font-size: 10px; }
        .item-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .item-status.pending { background: #fff3cd; color: #856404; }
        .item-status.applied { background: #d4edda; color: #155724; }
        .item-status.failed { background: #f8d7da; color: #721c24; }
        .btn { background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .btn:disabled { background: #ccc; }
        .btn-apply { background: #28a745; }
        .btn-row { display: flex; gap: 5px; margin-top: 10px; }
        .btn-main { flex: 1; padding: 10px; font-size: 12px; }
        #log { margin-top: 10px; font-size: 9px; color: #666; max-height: 60px; overflow-y: auto; background: #f9f9f9; padding: 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Karolina</h1>
        <div id="status" class="status">Connecting...</div>
        <div id="itemList"></div>
        <div class="btn-row">
            <button class="btn btn-main btn-apply" onclick="applyPending()">Apply Pending</button>
            <button class="btn btn-main" onclick="clearApplied()">Clear Done</button>
        </div>
        <div id="log"></div>
    </div>
    <script>
        const GIST_API = 'https://api.github.com/gists/141fe561464485dce58ad05f8c9b180c';
        let items = [];
        let itemStates = {}; // Track: pending, applied, failed
        
        function log(msg) { 
            document.getElementById('log').innerHTML = msg + '<br>' + document.getElementById('log').innerHTML; 
        }
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                document.getElementById('status').textContent = '‚úÖ Connected';
                loadItems();
                setInterval(loadItems, 10000);
            }
        });
        
        async function loadItems() {
            try {
                const response = await fetch(GIST_API, { headers: { 'Accept': 'application/vnd.github.v3+json' } });
                const gist = await response.json();
                const data = JSON.parse(gist.files['comments.json'].content);
                
                // Merge with existing states
                items = data.comments || [];
                items.forEach(item => {
                    if (!itemStates[item.id]) itemStates[item.id] = 'pending';
                });
                
                renderItems();
                
                const pending = items.filter(i => itemStates[i.id] === 'pending').length;
                document.getElementById('status').textContent = '‚úÖ ' + pending + ' pending, ' + (items.length - pending) + ' done';
            } catch (err) {
                log('Load error: ' + err.message);
            }
        }
        
        function renderItems() {
            document.getElementById('itemList').innerHTML = items.map(item => {
                const state = itemStates[item.id] || 'pending';
                let actionText = '';
                let icon = 'üí¨';
                
                if (item.type === 'heading') {
                    icon = 'üìë';
                    actionText = 'Heading ' + item.level;
                } else if (item.type === 'suggestion' || item.newText !== undefined) {
                    icon = '‚úèÔ∏è';
                    actionText = '‚Üí ' + item.newText;
                } else {
                    actionText = item.comment;
                }
                
                const typeClass = item.type === 'heading' ? ' heading' : '';
                return '<div class="item ' + state + typeClass + '">' +
                    '<div class="item-header">' +
                        '<span class="item-text">"' + item.searchText.substring(0, 40) + (item.searchText.length > 40 ? '...' : '') + '"</span>' +
                        '<span class="item-status ' + state + '">' + state + '</span>' +
                    '</div>' +
                    '<div class="item-comment">' + icon + ' ' + actionText + '</div>' +
                    (state === 'pending' ? '<button class="btn" onclick="applyOne(' + item.id + ')">Apply</button>' : '') +
                '</div>';
            }).join('');
        }
        
        async function applyOne(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            
            await Word.run(async (context) => {
                context.document.changeTrackingMode = Word.ChangeTrackingMode.trackAll;
                const results = context.document.body.search(item.searchText, { matchCase: false });
                results.load('items');
                await context.sync();
                
                if (results.items.length > 0) {
                    const range = results.items[0];
                    
                    if (item.type === 'heading' && item.level) {
                        // Apply heading style - need to get the paragraph containing this text
                        const para = range.paragraphs.getFirst();
                        para.load('style');
                        await context.sync();
                        
                        const headingStyle = 'Heading ' + item.level;
                        para.style = headingStyle;
                        await context.sync();
                        itemStates[id] = 'applied';
                        log('‚úÖ H' + item.level + ': ' + item.searchText.substring(0, 30));
                    } else if (item.type === 'suggestion' || item.newText !== undefined) {
                        range.insertText(item.newText, Word.InsertLocation.replace);
                        await context.sync();
                        itemStates[id] = 'applied';
                        log('‚úÖ ' + item.searchText.substring(0, 30));
                    } else if (item.type === 'comment' || item.comment) {
                        range.insertComment(item.comment);
                        await context.sync();
                        itemStates[id] = 'applied';
                        log('‚úÖ üí¨ ' + item.searchText.substring(0, 30));
                    }
                } else {
                    itemStates[id] = 'failed';
                    log('‚ùå Not found: ' + item.searchText.substring(0, 30));
                }
            }).catch(err => {
                itemStates[id] = 'failed';
                log('‚ùå Error: ' + err.message);
            });
            renderItems();
        }
        
        async function applyPending() {
            for (const item of items) {
                if (itemStates[item.id] === 'pending') {
                    await applyOne(item.id);
                }
            }
        }
        
        function clearApplied() {
            items = items.filter(i => itemStates[i.id] === 'pending' || itemStates[i.id] === 'failed');
            renderItems();
            log('Cleared applied items');
        }
    </script>
</body>
</html>
