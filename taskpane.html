<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Karolina Comments</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        h1 { font-size: 20px; color: #333; margin: 0 0 20px 0; }
        .status { padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .status.connected { background: #d4edda; color: #155724; }
        .pending-item { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea; }
        .btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn:disabled { background: #ccc; }
        #log { margin-top: 15px; font-size: 11px; color: #666; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Karolina Comments</h1>
        <div id="status" class="status">Connecting...</div>
        <div id="pendingList"></div>
        <button class="btn" onclick="processComments()" id="processBtn" disabled>Insert All Comments</button>
        <div id="log"></div>
    </div>
    <script>
        const GIST_URL = 'https://gist.githubusercontent.com/taxesfortacos/141fe561464485dce58ad05f8c9b180c/raw/comments.json';
        let pendingComments = [];
        
        function log(msg) { document.getElementById('log').innerHTML = msg + '<br>' + document.getElementById('log').innerHTML; }
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '‚úÖ Connected - Polling every 5s...';
                pollForComments();
                setInterval(pollForComments, 5000);
            }
        });
        
        async function pollForComments() {
            try {
                const response = await fetch(GIST_URL + '?nocache=' + Date.now());
                const text = await response.text();
                log('Raw: ' + text.substring(0, 50) + '...');
                const data = JSON.parse(text);
                pendingComments = (data.comments || []).filter(c => c.status === 'pending');
                
                if (pendingComments.length > 0) {
                    document.getElementById('pendingList').innerHTML = pendingComments.map(c => 
                        '<div class="pending-item"><b>"' + c.searchText + '"</b><br>üí¨ ' + c.comment + '</div>'
                    ).join('');
                    document.getElementById('processBtn').disabled = false;
                } else {
                    document.getElementById('pendingList').innerHTML = '<p style="color:#888">No pending comments</p>';
                }
            } catch (err) {
                log('Error: ' + err.message);
            }
        }
        
        async function processComments() {
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = 'Processing...';
            
            for (const c of pendingComments) {
                try {
                    await Word.run(async (context) => {
                        const results = context.document.body.search(c.searchText, { matchCase: false });
                        results.load('items');
                        await context.sync();
                        if (results.items.length > 0) {
                            results.items[0].insertComment(c.comment);
                            await context.sync();
                            log('‚úÖ Added comment for: ' + c.searchText);
                        } else {
                            log('‚ùå Text not found: ' + c.searchText);
                        }
                    });
                } catch (err) {
                    log('Error: ' + err.message);
                }
            }
            
            document.getElementById('pendingList').innerHTML = '<p style="color:green">‚úÖ All comments inserted!</p>';
            document.getElementById('processBtn').textContent = 'Insert All Comments';
            pendingComments = [];
        }
    </script>
</body>
</html>
